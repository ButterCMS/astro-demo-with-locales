---
import Hero from "../components/Hero.astro";
import Cta from "../components/Cta.astro";
import FeatureSection from "../components/FeatureSection.astro";
import TestimonialSection from "../components/TestimonialSection.astro";
import BlogSection from "../components/BlogSection.astro";
import MySiteLayout from "../layouts/MySiteLayout.astro";
import SEO from "./SEOs.astro";
import { butterCMS } from "../utils/buttercmssdk";

const { pathname } = Astro.url;
const urlQuery = pathname.split("/")[2];

const data = await butterCMS.page
	.retrieve("landing-page", urlQuery || "landing-page-with-components")
	.then((r) => {
		return r.data.data;
	})
	.catch((err) => {
		console.log(err, "err");
	});

const posts = await butterCMS.post.list({ page: 1, page_size: 2 });

const sectionData = data.fields.body;
const blogPosts = posts.data.data;
---

<script>
	if (!import.meta.env.PUBLIC_APITOKEN) {
		window.location.assign("/404");
	}
</script>

<MySiteLayout>
	<SEO {...data.fields.seo} />

	{
		sectionData.map((i) => {
			switch (i.type) {
				case "testimonials":
					return (
						<TestimonialSection fields={i.fields} key={i.type} />
					);
				case "hero":
					return <Hero fields={i.fields} key={i.type} />;
				case "two_column_with_image":
					return <Cta fields={i.fields} key={i.type} />;
				case "features":
					return <FeatureSection fields={i.fields} key={i.type} />;
				default:
					null;
			}
		})
	}
	<BlogSection blogPosts={blogPosts} />
</MySiteLayout>
